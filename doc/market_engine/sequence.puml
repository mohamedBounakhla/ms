@startuml
!theme plain

participant "Portfolio BC" as P
participant "Market Engine" as ME
participant "Order BC" as O
participant "OrderBook BC" as OB

P -> ME : BuyOrderRequestedEvent
ME -> O : createBuyOrderWithReservation()
O -> O : Save Order
O -> ME : OrderCreatedEvent

ME -> O : findOrderById()
O --> ME : Order Details
ME -> OB : addOrderToBook(order)
OB -> OB : Check for matches

alt Match Found
    OB -> ME : OrderMatchedEvent
    ME -> O : createTransactionFromMatch()
    O -> O : Create Transaction
    O -> ME : TransactionCreatedEvent
    ME -> P : handleTransactionCreated()
    P -> P : Update balances
else No Match
    OB --> ME : Success (no matches)
    ME -> ME : Flow ends
end

@enduml