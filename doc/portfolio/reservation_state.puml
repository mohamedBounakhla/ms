@startuml Reservation State Pattern

!define ACTIVECOLOR #87CEEB
!define CONSUMEDCOLOR #90EE90
!define FREEDCOLOR #FFB6C1

skinparam state {
    BackgroundColor #F5F5F5
    BorderColor #333333
    FontColor #333333
    StartColor #4CAF50
    EndColor #F44336
    FontSize 12
}

title Reservation State Pattern - Simplified Design

' State Diagram
[*] --> Pending : create()

state Pending #ACTIVECOLOR {
    Pending : **Resources:** LOCKED
    Pending : entry / lockResources()
    Pending : do / trackExpirationTime()
    Pending : exit / logTransition()
    --
    Pending : + canConfirm() = true
    Pending : + canCancel() = true
    Pending : + canExpire() = true
    Pending : + hasLockedResources() = true
}

state Executed #CONSUMEDCOLOR {
    Executed : **Resources:** CONSUMED
    Executed : entry / consumeResources()
    Executed : entry / updatePortfolioPosition()
    Executed : type = TERMINAL
    --
    Executed : + canConfirm() = false
    Executed : + canCancel() = false
    Executed : + canExpire() = false
    Executed : + hasLockedResources() = false
}

state Released #FREEDCOLOR {
    Released : **Resources:** FREED
    Released : entry / releaseResources()
    Released : entry / restoreAvailableBalance()
    Released : type = TERMINAL
    --
    Released : + canConfirm() = false
    Released : + canCancel() = false
    Released : + canExpire() = false
    Released : + hasLockedResources() = false
}

Pending --> Executed : confirm()\n[order matched]
Pending --> Released : cancel()\n[user/system cancellation]
Pending --> Released : expire()\n[timeout reached]

Executed --> [*]
Released --> [*]

note right of Pending
    **The only active state**
    Resources are reserved but not consumed
    All business decisions happen here
end note

note bottom of Executed
    **Success Terminal State**
    Order was matched
    Resources have been consumed
    Portfolio positions updated
end note

note bottom of Released
    **Failure Terminal State**
    Order was not matched
    Resources returned to available
    Reason: cancellation OR expiration
end note

@enduml